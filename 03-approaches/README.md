# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

---
### Выбор програмных продуктов
1. **GitHub** для системы контроля версий и хранения исходного кода.
2. **GitHub Actions** для непрерывной интеграции и непрерывной поставки (CI/CD).
3. **Docker** для управления контейнерами и создания собственных докер-образов.
4. **HashiCorp Vault** для безопасного хранения секретных данных.

### Архитектура решения

#### 1. Хранение исходного кода

- **GitHub**:
  - Используется для хранения исходного кода.
  - Создается отдельный репозиторий для каждого сервиса.
  - Встроенные возможности для управления версиями и контроля доступа.

#### 2. Непрерывная интеграция и поставка

- **GitHub Actions**:
  - Запуск сборки по событию из системы контроля версий.
  - Запуск сборки по кнопке с указанием параметров через GitHub Actions.
  - Настройки для каждой сборки с использованием YAML-файлов.
  - Создание шаблонов для различных конфигураций сборок.
  - Поддержка кастомных шагов при сборке.
  - Параллельный запуск нескольких сборок и тестов.

- **Docker**:
  - Использование собственных докер-образов для сборки проектов.
  - Облегчение развертывания приложений и тестирования.

#### 3. Безопасное хранение секретных данных

- **HashiCorp Vault**:
  - Безопасное хранение секретных данных (пароли, ключи доступа).
  - Интеграция с GitHub Actions для использования секретных данных в сборках.  

### Обоснование выбора

1. **GitHub**:
   - Надежная и масштабируемая платформа.
   - Удобные инструменты для управления версиями и контроля доступа.
   - Прямая интеграция с GitHub Actions для CI/CD.
   - Можно бы рассмотреть GitLab и BitBucket, но с BitBucket мало опыта, а у GitLab
   ограничения на количество разработчиков (5 если не ошибаюсь для приватных репозиторий)
   если без подписки. Я фриланс разработчик и работодатели хотя на всем сэкономить.
   Если бы не это то выбор был бы GitLab.

2. **GitHub Actions**:
   - Полностью интегрирован с GitHub, что облегчает настройку CI/CD.
   - Поддержка широкого спектра действий и шаблонов для различных конфигураций сборок.
   - Легкость запуска сборок по событию из системы контроля версий или по кнопке.
   - Возможность параллельного выполнения задач и тестов.
   - Возможность использовать кастомные шаги и параметры для сборок.

3. **Docker**:
   - Универсальное средство для контейнеризации приложений.
   - Облегчение развертывания и тестирования.
   - Поддержка создания собственных докер-образов.
   - Можно было еще podman использовать, но тут от личного выбора. RedHat был 1 линуксом который я юзал.
   и с тех пор RedHat и python я недолюбливаю. Второй по причине что его иконка все время где то появлялась
   и я постоянно на нее нажимал, а выйти не мог =) Ну и переустанавливал я это все раза 3 за день.
   Все поменялось когда появился Debian огромный и куча доков.

4. **HashiCorp Vault**:
   - Высокий уровень безопасности для хранения секретных данных.
   - Удобная интеграция с CI/CD системами.
---

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

---
### Решение для сбора и анализа логов сервисов в микросервисной архитектуре

#### Инструменты:

1. **Promtail** для сбора логов.
2. **Grafana Loki** для хранения и обработки логов.
3. **ClickHouse** для хранения и анализа структурированных логов и метрик.
4. **Grafana** для визуализации и предоставления пользовательского интерфейса.

### Обоснование выбора:

#### 1. Promtail

**Почему:**
- **Сбор логов в центральное хранилище со всех хостов**: Promtail развернут на каждом хосте и собирает логи.
- **Минимальные требования к приложениям, сбор логов из stdout**: Promtail может быть настроен для сбора логов из stdout, что делает его подходящим для микросервисов.
- **Гарантированная доставка логов до центрального хранилища**: Promtail поддерживает надежную доставку логов в Grafana Loki.

#### 2. Grafana Loki

**Почему:**
- **Гарантированная доставка логов до центрального хранилища**: Loki предназначен для горизонтального масштабирования и надежной доставки логов.
- **Обеспечение поиска и фильтрации по записям логов**: Loki поддерживает мощные возможности поиска и фильтрации логов с использованием языка запросов, схожего с PromQL.
- **Интеграция с Grafana**: Loki легко интегрируется с Grafana, обеспечивая удобный интерфейс для поиска и анализа логов.

#### 3. ClickHouse

**Почему:**
- **Хранение и анализ структурированных логов и метрик**: ClickHouse отлично подходит для хранения больших объемов структурированных данных и позволяет выполнять быстрый и сложный анализ.
- **Интеграция с Grafana**: ClickHouse интегрируется с Grafana, что позволяет визуализировать и анализировать данные из ClickHouse вместе с логами из Loki.

#### 4. Grafana

**Почему:**
- **Обеспечение пользовательского интерфейса**: Grafana предоставляет мощный и гибкий интерфейс для визуализации данных из различных источников, включая Loki и ClickHouse.
- **Возможность предоставления доступа разработчикам для поиска по записям логов**: В Grafana можно настроить доступ для разработчиков, чтобы они могли выполнять поиск и анализ логов.
- **Возможность сохранения и предоставления доступа к сохранённым поискам**: Grafana позволяет сохранять поисковые запросы и дашборды, которыми можно делиться с другими пользователями через ссылки.

### Пример взаимодействия инструментов:

1. **Сбор логов**:
   - Promtail развернут на каждом хосте и собирает логи из stdout микросервисов и других источников.
   - Promtail может быть настроен для передачи структурированных данных и метрик в ClickHouse, если это необходимо.

2. **Передача логов**:
   - Promtail отправляет собранные логи в Grafana Loki.

3. **Хранение и обработка логов**:
   - Grafana Loki принимает и хранит логи, обеспечивая возможности поиска и фильтрации.
   - ClickHouse хранит структурированные данные и метрики для последующего анализа.

4. **Визуализация и анализ**:
   - Grafana подключается к Grafana Loki и ClickHouse, предоставляя интерфейс для визуализации, поиска и анализа логов и метрик.
   - Разработчики могут использовать Grafana для создания дашбордов, выполнения поисков и анализа данных.
   - Возможность сохранения и предоставления доступа к сохранённым поискам обеспечивается через функционал Grafana.

### Заключение:

Использование Promtail в сочетании с Grafana Loki, ClickHouse и Grafana обеспечивает эффективное и масштабируемое решение для сбора, хранения, анализа и визуализации логов и метрик в микросервисной архитектуре. Promtail обеспечивает тесную интеграцию с Loki, что упрощает настройку и эксплуатацию системы логирования. Grafana предоставляет мощный интерфейс для работы с данными, а ClickHouse позволяет эффективно анализировать структурированные данные и метрики. Такое решение отвечает всем указанным требованиям и обеспечивает высокую надежность и гибкость.
---

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

---
Для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре можно предложить следующее решение, состоящее из нескольких программных продуктов:

1. **Prometheus** для сбора метрик.
2. **Grafana** для визуализации метрик.
3. **Node Exporter** для сбора метрик состояния ресурсов хостов.
4. **cAdvisor** для сбора метрик потребляемых ресурсов контейнеров.
5. **Custom Exporters** для сбора метрик, специфичных для каждого сервиса.

### Обоснование выбора:

#### 1. Prometheus

**Почему:**
- **Сбор метрик со всех хостов**: Prometheus поддерживает сбор метрик через pull-модель, регулярно опрашивая экспортёры метрик.
- **Гарантированная доставка метрик**: Prometheus обеспечивает надежный сбор и хранение метрик, с возможностью настройки ретенции данных.
- **Сбор метрик состояния ресурсов хостов и сервисов**: Prometheus легко интегрируется с различными экспортёрами, такими как Node Exporter и cAdvisor, для сбора необходимых метрик.

#### 2. Grafana

**Почему:**
- **Пользовательский интерфейс с возможностью делать запросы и агрегировать информацию**: Grafana предоставляет мощный и гибкий интерфейс для построения запросов и визуализации данных из Prometheus.
- **Настройка различных панелей для отслеживания состояния системы**: Grafana позволяет создавать и настраивать дашборды для мониторинга состояния системы в реальном времени.

#### 3. Node Exporter

**Почему:**
- **Сбор метрик состояния ресурсов хостов (CPU, RAM, HDD, Network)**: Node Exporter собирает и передает метрики состояния хостов в Prometheus, обеспечивая мониторинг использования ресурсов.

#### 4. cAdvisor

**Почему:**
- **Сбор метрик потребляемых ресурсов для каждого сервиса (CPU, RAM, HDD, Network)**: cAdvisor интегрируется с Docker и Kubernetes, собирая метрики потребления ресурсов для каждого контейнера и отправляя их в Prometheus.

#### 5. Custom Exporters

**Почему:**
- **Сбор метрик, специфичных для каждого сервиса**: Для сбора метрик, специфичных для каждого сервиса, можно разработать пользовательские экспортёры, которые будут отправлять данные в Prometheus.

### Заключение:

Это решение охватывает все ваши требования, предоставляя мощные инструменты для сбора, хранения и визуализации метрик. Prometheus обеспечивает надежный сбор и хранение метрик, Node Exporter и cAdvisor собирают необходимые данные о состоянии ресурсов хостов и контейнеров, а Grafana предоставляет гибкий интерфейс для мониторинга и анализа состояния системы. Разработка пользовательских экспортёров позволяет собирать специфичные метрики для каждого сервиса, что делает это решение масштабируемым и адаптируемым под нужды вашей архитектуры.
---

## Задача 4: Логи * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, пишут логи в stdout. 

Добавить в систему сервисы для сбора логов Vector + ElasticSearch + Kibana со всех сервисов, обеспечивающих работу API.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Kibana.
Логин в Kibana должен быть admin, пароль qwerty123456.


## Задача 5: Мониторинг * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, предоставляют набор метрик в формате prometheus:

- сервис security по адресу /metrics,
- сервис uploader по адресу /metrics,
- сервис storage (minio) по адресу /minio/v2/metrics/cluster.

Добавить в систему сервисы для сбора метрик (Prometheus и Grafana) со всех сервисов, обеспечивающих работу API.
Построить в Graphana dashboard, показывающий распределение запросов по сервисам.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Grafana с настроенным Dashboard.
Логин в Grafana должен быть admin, пароль qwerty123456.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
